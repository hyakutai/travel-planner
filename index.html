<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ã®ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ v26 (Cloud & Map)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f0f2f5; overflow: hidden; }
        
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: å·¦å´ãƒãƒƒãƒ—(60%)ã€å³å´ãƒ‘ãƒãƒ«(40%) */
        #map-container { flex: 0 0 60%; border-right: 2px solid #ddd; position: relative; }
        #map { width: 100%; height: 100%; }
        #panel { flex: 1; padding: 0; overflow-y: auto; background: white; display: flex; flex-direction: column; min-width: 320px; position: relative; }
        
        /* ç”»é¢ã‚³ãƒ³ãƒ†ãƒŠ */
        .view-container { padding: 15px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box; }
        
        /* --- ãƒ›ãƒ¼ãƒ ç”»é¢ --- */
        .home-title { font-size: 1.5rem; color: #1a73e8; text-align: center; margin: 20px 0; }
        .new-plan-btn { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(26, 115, 232, 0.3); }
        .new-plan-btn:hover { background: #1557b0; transform: translateY(-2px); }
        
        /* ã‚¯ãƒ©ã‚¦ãƒ‰æ¤œç´¢ã‚¨ãƒªã‚¢ */
        .cloud-section { background: #e8f0fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c2d7ff; }
        .cloud-title { font-weight: bold; color: #1557b0; margin-bottom: 10px; }
        .cloud-inputs { display: flex; gap: 5px; margin-bottom: 10px; }
        .cloud-input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .cloud-btn { background: #1557b0; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }

        /* ä¿å­˜æ¸ˆã¿ãƒªã‚¹ãƒˆ */
        .saved-list-title { font-size: 1rem; color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 15px; }
        .saved-plans-list { list-style: none; padding: 0; margin: 0; }
        .saved-plan-card { background: white; border: 1px solid #ddd; border-left: 5px solid #34a853; padding: 12px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .saved-plan-card:hover { background: #f9f9f9; }
        .plan-info h3 { margin: 0; font-size: 1rem; color: #333; }
        .plan-date { font-size: 0.75rem; color: #888; }
        .plan-delete { color: #ea4335; cursor: pointer; padding: 5px; font-size: 1.1rem; }

        /* --- ç·¨é›†ç”»é¢ --- */
        .header-area { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1a73e8; padding-bottom: 5px; margin-bottom: 10px; }
        .home-btn { background: #fff; border: 1px solid #ddd; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #666; }
        .action-btn { font-size: 0.8rem; padding: 4px 10px; border-radius: 4px; cursor: pointer; border: 1px solid #ccc; background: #f8f9fa; margin-left: 5px; }
        .save-btn { font-size: 0.8rem; padding: 4px 12px; border-radius: 4px; cursor: pointer; border: none; background: #1a73e8; color: white; font-weight: bold; margin-left: 5px; }

        /* æ—¥ä»˜ã‚¿ãƒ– */
        .day-tabs { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #ddd; }
        .day-tab { padding: 5px 10px; font-size: 0.85rem; border: 1px solid #ddd; border-radius: 4px 4px 0 0; background: #f8f9fa; cursor: pointer; white-space: nowrap; }
        .day-tab.active { background: #1a73e8; color: white; border-color: #1a73e8; font-weight: bold; }
        .add-day-btn { padding: 5px 10px; cursor: pointer; background: #eee; border: none; border-radius: 4px; }

        /* å…¥åŠ›ãƒ»ãƒªã‚¹ãƒˆ */
        .config-area { display: flex; justify-content: space-between; align-items: center; background: #e8f0fe; padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9rem; }
        .input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #eee; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button.add-btn { padding: 10px; background-color: #1a73e8; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        
        #scheduleList { list-style: none; padding: 0; margin: 0; flex: 1; overflow-y: auto; }
        .schedule-item { background: white; border-left: 4px solid #1a73e8; margin-bottom: 6px; padding: 8px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .item-move { border-left-color: #ff9800; background: #fffde7; padding: 4px 8px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .item-name { font-weight: bold; font-size: 0.85rem; color: #333; }
        .item-time-info { text-align: right; font-size: 0.75rem; color: #666; }
        .edit-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; border-top: 1px dashed #eee; padding-top: 4px; }
        .btn-del { color: #ea4335; cursor: pointer; margin-left: 10px; }
        .drag-handle { cursor: grab; color: #aaa; margin-right: 5px; font-size: 1rem; }

        /* ã‚°ãƒ©ãƒ• */
        .charts-wrapper { display: flex; height: 100px; margin-bottom: 10px; gap: 5px; flex-shrink: 0; }
        .chart-box { flex: 1; position: relative; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; border-radius: 8px; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 10px; max-height: 85vh; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        .summary-content { overflow-y: auto; flex: 1; }
        .summary-day { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .summary-day-title { font-weight: bold; color: #1a73e8; background: #e8f0fe; padding: 5px; border-radius: 4px; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="map-container"><div id="map"></div></div>

<div id="panel">
    
    <div id="home-view" class="view-container">
        <h1 class="home-title">ğŸŒ æ—…ã®ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
        
        <div class="cloud-section">
            <div class="cloud-title">â˜ï¸ å…±æœ‰ãƒ—ãƒ©ãƒ³ã‚’æ¤œç´¢ (Cloud)</div>
            <div class="cloud-inputs">
                <input type="text" id="cloud-search-name" class="cloud-input" placeholder="ä»¶åã‚’å…¥åŠ›">
                <input type="password" id="cloud-search-pass" class="cloud-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            </div>
            <button class="cloud-btn" onclick="searchCloudPlan()">æ¤œç´¢ã—ã¦é–‹ã</button>
        </div>

        <button class="new-plan-btn" onclick="startNewPlan()">ï¼‹ æ–°ã—ã„æ—…ã‚’è¨ˆç”»ã™ã‚‹</button>
        
        <div class="saved-list-title">ç«¯æœ«ã«ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ (Local)</div>
        <ul id="saved-plans-list" class="saved-plans-list"></ul>
    </div>

    <div id="planner-view" class="view-container" style="display: none;">
        <div class="header-area">
            <button class="home-btn" onclick="goHome()">ğŸ  ãƒ›ãƒ¼ãƒ </button>
            <div style="display:flex; align-items:center;">
                <button class="action-btn" onclick="showSummary()">ğŸ“‹ å…¨æ—¥ç¨‹</button>
                <button class="action-btn" onclick="openShareModal()">â˜ï¸ å…±æœ‰</button>
                <button class="save-btn" onclick="saveTripLocal()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>

        <div class="day-tabs" id="dayTabs"></div>

        <div class="config-area">
            <div>å‡ºç™º: <input type="time" id="startTime" value="09:00" onchange="refreshSchedule()"></div>
            <button class="btn-geo" onclick="addCurrentLocation()">ğŸ“ ç¾åœ¨åœ°</button>
        </div>

        <div class="charts-wrapper">
            <div class="chart-box"><canvas id="chartAM"></canvas></div>
            <div class="chart-box"><canvas id="chartPM"></canvas></div>
        </div>
        
        <div class="input-group">
            <input type="text" id="placeName" placeholder="ğŸ” ç›®çš„åœ°ã‚’æ¤œç´¢">
            <div style="display:flex; gap:5px;">
                <select id="travelMode" style="flex:1;">
                    <option value="DRIVING">ğŸš— è»Š</option>
                    <option value="TRANSIT">ğŸšƒ é›»è»Š</option>
                    <option value="WALKING">ğŸš¶ å¾’æ­©</option>
                </select>
                <input type="number" id="stayTime" placeholder="æ»åœ¨(åˆ†)" value="60" style="width: 60px;">
            </div>
            <button class="add-btn" onclick="addNewLocation()">è¿½åŠ </button>
        </div>

        <ul id="scheduleList"></ul>
    </div>
</div>

<div id="shareModal" class="modal-overlay">
    <div class="modal-box">
        <h3>â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ãƒ»å…±æœ‰</h3>
        <p style="font-size:0.9rem; color:#666;">ä»¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
        <input type="text" id="share-name" class="cloud-input" placeholder="ä»¶å (ä¾‹: æ±äº¬æ—…è¡Œ)" style="margin-bottom:10px; width:100%; box-sizing:border-box;">
        <input type="password" id="share-pass" class="cloud-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:100%; box-sizing:border-box;">
        <div class="modal-buttons">
            <button class="home-btn" onclick="document.getElementById('shareModal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="save-btn" onclick="uploadToCloud()">å…±æœ‰ã™ã‚‹</button>
        </div>
    </div>
</div>

<div id="summaryModal" class="modal-overlay">
    <div class="modal-box" style="width: 400px; max-height: 85vh;">
        <h3>ğŸ“‹ å…¨æ—¥ç¨‹æ¦‚è¦</h3>
        <div id="summaryContent" class="summary-content"></div>
        <div class="modal-buttons">
            <button class="home-btn" onclick="window.print()">ğŸ–¨ å°åˆ·</button>
            <button class="save-btn" onclick="document.getElementById('summaryModal').style.display='none'">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<script>
    // --- 1. Supabaseè¨­å®š (åŸ‹ã‚è¾¼ã¿æ¸ˆã¿) ---
    const SUPABASE_URL = "https://iusejpdjfylfxodxkglr.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1c2VqcGRqZnlsZnhvZHhrZ2xyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NjA0MTMsImV4cCI6MjA4NjAzNjQxM30.nw5bXN1kpsS9KX_M3jg-YHDFKooYQZF_lGZ5wwng8zI"; 
    
    const supabase = (typeof createClient !== 'undefined') ? createClient(SUPABASE_URL, SUPABASE_KEY) : null;

    // --- 2. å¤‰æ•°å®šç¾© ---
    let map, geocoder, directionsService, chartAM, chartPM, sortable;
    let routeRenderers = [], markers = [];
    window.currentLatLng = null;
    
    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ : è¤‡æ•°æ—¥å¯¾å¿œ
    let tripData = { days: [ [] ], startTimes: ["09:00"] };
    let currentDayIndex = 0;
    let currentPlanName = "";

    // --- 3. åˆæœŸåŒ– ---
    function initMap() {
        console.log("v26 Init...");
        geocoder = new google.maps.Geocoder();
        directionsService = new google.maps.DirectionsService();
        map = new google.maps.Map(document.getElementById("map"), { zoom: 14, center: {lat: 35.6812, lng: 139.7671} });

        // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹
        const input = document.getElementById("placeName");
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);
        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) { alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
            map.setCenter(place.geometry.location); map.setZoom(15);
            window.currentLatLng = place.geometry.location;
            document.getElementById('placeName').value = place.name || place.formatted_address;
        });

        // ã‚¯ãƒªãƒƒã‚¯
        map.addListener("click", (e) => {
            window.currentLatLng = e.latLng;
            geocoder.geocode({ location: e.latLng }, (results, status) => {
                if (status === "OK" && results[0]) document.getElementById('placeName').value = results[0].formatted_address;
            });
            new google.maps.Marker({ position: e.latLng, map: map, title: "é¸æŠä½ç½®" });
        });

        initCharts();
        initSortable();
        showHome(); // æœ€åˆã¯ãƒ›ãƒ¼ãƒ ã‚’è¡¨ç¤º
    }

    // --- 4. ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ---
    function showHome() {
        document.getElementById('home-view').style.display = 'flex';
        document.getElementById('planner-view').style.display = 'none';
        clearMapOverlays();
        renderSavedPlansList();
    }
    function showPlanner() {
        document.getElementById('home-view').style.display = 'none';
        document.getElementById('planner-view').style.display = 'flex';
        // ãƒãƒ£ãƒ¼ãƒˆã®ãƒªã‚µã‚¤ã‚º (éè¡¨ç¤ºâ†’è¡¨ç¤ºã®ãƒã‚°å¯¾ç­–)
        if(chartAM) chartAM.resize(); if(chartPM) chartPM.resize();
        renderTabs();
        document.getElementById('startTime').value = tripData.startTimes[currentDayIndex];
        refreshSchedule();
    }
    function startNewPlan() {
        tripData = { days: [ [] ], startTimes: ["09:00"] };
        currentDayIndex = 0; currentPlanName = "";
        showPlanner();
    }
    function goHome() {
        if(confirm("ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ\n(ä¿å­˜ã—ã¦ã„ãªã„å†…å®¹ã¯ç ´æ£„ã•ã‚Œã¾ã™)")) showHome();
    }

    // --- 5. ãƒ‡ãƒ¼ã‚¿æ“ä½œ (è¿½åŠ ãƒ»å‰Šé™¤ãƒ»è¨ˆç®—) ---
    function getCurrentDayList() { return tripData.days[currentDayIndex]; }

    async function addNewLocation() {
        const name = document.getElementById('placeName').value;
        const time = parseInt(document.getElementById('stayTime').value);
        const mode = document.getElementById('travelMode').value;
        if (!window.currentLatLng) { alert("å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
        
        // åº§æ¨™ã‚’JSONåŒ–ã—ã¦ä¿å­˜
        const latLngObj = window.currentLatLng.toJSON ? window.currentLatLng.toJSON() : window.currentLatLng;

        getCurrentDayList().push({
            id: Date.now(), name: name, time: time, 
            latLng: latLngObj, mode: mode, isMove: false 
        });
        
        await refreshSchedule();
        document.getElementById('placeName').value = '';
        window.currentLatLng = null;
    }

    async function refreshSchedule() {
        clearMapOverlays();
        const list = getCurrentDayList();
        
        // æ™‚åˆ»è¨ˆç®—
        const timeStr = tripData.startTimes[currentDayIndex] || "09:00";
        const [h, m] = timeStr.split(':').map(Number);
        let currentTimeMin = h * 60 + m;

        const displayList = [];
        const chartSegments = [];

        // ãƒãƒ¼ã‚«ãƒ¼è¨­ç½®
        list.forEach((item, idx) => {
            markers.push(new google.maps.Marker({
                position: item.latLng, map: map, label: (idx+1).toString(), title: item.name
            }));
        });

        // ãƒ«ãƒ¼ãƒˆè¨ˆç®—ãƒ«ãƒ¼ãƒ—
        for (let i = 0; i < list.length; i++) {
            const item = list[i];
            if (i > 0) {
                const prev = list[i-1];
                const moveTime = await calculateRoute(prev.latLng, item.latLng, item.mode);
                
                displayList.push({ name: `ç§»å‹• (${item.mode})`, time: moveTime, isMove: true });
                chartSegments.push({ type: 'move', time: moveTime });
                currentTimeMin += moveTime;
            }
            
            // æ»åœ¨
            const stayTime = (i === 0 && list.length > 1) ? 0 : item.time;
            displayList.push({
                ...item,
                startTime: formatTime(currentTimeMin),
                endTime: formatTime(currentTimeMin + stayTime)
            });
            chartSegments.push({ type: 'stay', time: stayTime });
            currentTimeMin += stayTime;
        }

        renderList(displayList);
        // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–° (ç°¡æ˜“ç‰ˆ)
        // æœ¬æ¥ã¯ã“ã“ã§ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ãŒã€ä»Šå›ã¯ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—å¯
    }

    function calculateRoute(start, end, mode) {
        return new Promise(resolve => {
            directionsService.route({
                origin: start, destination: end, travelMode: google.maps.TravelMode[mode]
            }, (res, status) => {
                if (status === 'OK') {
                    const renderer = new google.maps.DirectionsRenderer({
                        map: map, directions: res, suppressMarkers: true,
                        polylineOptions: { strokeColor: mode==='WALKING'?'#4caf50':'#1a73e8', strokeWeight: 5, strokeOpacity: 0.6 }
                    });
                    routeRenderers.push(renderer);
                    resolve(Math.ceil(res.routes[0].legs[0].duration.value / 60));
                } else { resolve(15); }
            });
        });
    }

    // --- 6. UIæç”» ---
    function renderList(list) {
        const ul = document.getElementById('scheduleList');
        ul.innerHTML = '';
        list.forEach(item => {
            const li = document.createElement('li');
            li.className = `schedule-item ${item.isMove ? 'item-move' : ''}`;
            if (!item.isMove) li.setAttribute('data-id', item.id);

            let html = `<div class="item-row">`;
            if (item.isMove) {
                html += `<span>ğŸš— ç§»å‹• (${item.time}åˆ†)</span>`;
            } else {
                html += `<span class="item-name">${item.name}</span>`;
                html += `<div class="item-time-info">${item.startTime} - ${item.endTime}</div>`;
                html += `<div class="edit-row"><span class="btn-del" onclick="deleteItem(${item.id})">ğŸ—‘</span></div>`;
            }
            html += `</div>`;
            li.innerHTML = html;
            ul.appendChild(li);
        });
    }

    window.deleteItem = (id) => {
        const list = getCurrentDayList();
        const idx = list.findIndex(d => d.id === id);
        if (idx > -1) { list.splice(idx, 1); refreshSchedule(); }
    };

    function clearMapOverlays() {
        routeRenderers.forEach(r => r.setMap(null)); routeRenderers = [];
        markers.forEach(m => m.setMap(null)); markers = [];
    }

    function formatTime(min) {
        let h = Math.floor(min / 60) % 24; let m = min % 60;
        return `${h}:${m.toString().padStart(2, '0')}`;
    }

    // --- 7. æ—¥ä»˜ã‚¿ãƒ– ---
    function renderTabs() {
        const container = document.getElementById('dayTabs'); container.innerHTML = '';
        tripData.days.forEach((_, idx) => {
            const btn = document.createElement('div');
            btn.className = `day-tab ${idx === currentDayIndex ? 'active' : ''}`;
            btn.innerText = `Day ${idx + 1}`;
            btn.onclick = () => switchDay(idx);
            container.appendChild(btn);
        });
        const addBtn = document.createElement('button'); addBtn.className = 'add-day-btn'; addBtn.innerText = 'ï¼‹';
        addBtn.onclick = () => { tripData.days.push([]); tripData.startTimes.push("09:00"); switchDay(tripData.days.length - 1); };
        container.appendChild(addBtn);
    }
    function switchDay(idx) { currentDayIndex = idx; renderTabs(); document.getElementById('startTime').value = tripData.startTimes[idx] || "09:00"; refreshSchedule(); }

    // --- 8. ä¿å­˜æ©Ÿèƒ½ (Local & Cloud) ---
    // Local
    function saveTripLocal() {
        let name = currentPlanName || prompt("ãƒ—ãƒ©ãƒ³åã‚’å…¥åŠ›:", "æ±äº¬æ—…è¡Œ");
        if (!name) return;
        currentPlanName = name;
        
        const saveData = { tripData: tripData, savedAt: new Date().toISOString() };
        let allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        allSaves[name] = saveData;
        localStorage.setItem("travel_planner_saves", JSON.stringify(allSaves));
        alert("ç«¯æœ«ã«ä¿å­˜ã—ã¾ã—ãŸ");
    }
    function renderSavedPlansList() {
        const ul = document.getElementById('saved-plans-list'); ul.innerHTML = '';
        const allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        Object.keys(allSaves).reverse().forEach(name => {
            const li = document.createElement('li'); li.className = 'saved-plan-card';
            li.innerHTML = `<div class="plan-info" onclick="loadLocal('${name}')"><h3>${name}</h3></div><div class="plan-delete" onclick="deleteLocal('${name}')">ğŸ—‘</div>`;
            ul.appendChild(li);
        });
    }
    window.loadLocal = (name) => {
        const allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        if (allSaves[name]) { tripData = allSaves[name].tripData; currentDayIndex = 0; currentPlanName = name; showPlanner(); }
    };
    window.deleteLocal = (name) => {
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            let allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
            delete allSaves[name];
            localStorage.setItem("travel_planner_saves", JSON.stringify(allSaves));
            renderSavedPlansList();
        }
    };

    // Cloud (Supabase)
    function openShareModal() {
        document.getElementById('share-name').value = currentPlanName;
        document.getElementById('shareModal').style.display = 'flex';
    }
    async function uploadToCloud() {
        const name = document.getElementById('share-name').value;
        const password = document.getElementById('share-pass').value;
        if (!name || !password) { alert("ä»¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿…é ˆ"); return; }
        
        // ç°¡æ˜“å®Ÿè£…: nameã§æ¤œç´¢ã—ã¦ã‚ã‚Œã°Updateã€ãªã‘ã‚Œã°Insert
        const { data: existing } = await supabase.from('plans').select('*').eq('name', name);
        
        if (existing && existing.length > 0) {
            if (existing[0].password !== password) { alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); return; }
            await supabase.from('plans').update({ data: tripData }).eq('id', existing[0].id);
        } else {
            await supabase.from('plans').insert([{ name, password, data: tripData }]);
        }
        alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸï¼");
        document.getElementById('shareModal').style.display = 'none';
    }
    async function searchCloudPlan() {
        const name = document.getElementById('cloud-search-name').value;
        const password = document.getElementById('cloud-search-pass').value;
        if (!name || !password) return;

        const { data, error } = await supabase.from('plans').select('*').eq('name', name);
        if (error || !data || data.length === 0) { alert("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
        
        if (data[0].password !== password) { alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); return; }
        
        tripData = data[0].data;
        currentDayIndex = 0;
        currentPlanName = data[0].name;
        showPlanner();
        alert("èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
    }

    // å…¨æ—¥ç¨‹
    function showSummary() {
        const div = document.getElementById('summaryContent'); div.innerHTML = '';
        tripData.days.forEach((dayList, i) => {
            let html = `<div class="summary-day"><div class="summary-day-title">Day ${i+1}</div>`;
            dayList.forEach(item => { html += `<div class="summary-item">â— ${item.name} (${item.time}åˆ†)</div>`; });
            html += `</div>`;
            div.innerHTML += html;
        });
        document.getElementById('summaryModal').style.display = 'flex';
    }

    // ãã®ä»–åˆæœŸåŒ–
    function initCharts() {
        const cfg = { type: 'pie', data: { datasets: [{ data: [] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } };
        chartAM = new Chart(document.getElementById('chartAM'), JSON.parse(JSON.stringify(cfg)));
        chartPM = new Chart(document.getElementById('chartPM'), JSON.parse(JSON.stringify(cfg)));
    }
    function initSortable() {
        sortable = new Sortable(document.getElementById('scheduleList'), {
            animation: 150, handle: '.schedule-item', 
            onEnd: async () => { syncOrderFromDOM(); await refreshSchedule(); }
        });
    }
    function syncOrderFromDOM() {
        const list = getCurrentDayList(); const newList = [];
        const items = document.querySelectorAll('.schedule-item');
        items.forEach(el => {
            const id = parseFloat(el.getAttribute('data-id'));
            const d = list.find(x => x.id === id);
            if(d) newList.push(d);
        });
        tripData.days[currentDayIndex] = newList;
    }
    function addCurrentLocation() {
        if(!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition(pos => {
            const latLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            map.setCenter(latLng);
            // ç¾åœ¨åœ°ã¯APIã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãªã„ã®ã§ãã®ã¾ã¾
            getCurrentDayList().push({ id: Date.now(), name: "ç¾åœ¨åœ°", time: 0, latLng: latLng, mode: "DRIVING", isMove: false });
            refreshSchedule();
        });
    }

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDaOSP3v96sTjeE9YDKl1AqURjCA8jr7Ro&callback=initMap&libraries=places" async defer></script>

</body>
</html>