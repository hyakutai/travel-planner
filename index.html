<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ—…ã®ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ Step 8 (Memo)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« (Step 7ã¨åŒã˜) --- */
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background-color: #f0f2f5; overflow: hidden; }
        #map-container { flex: 6; border-right: 2px solid #ddd; }
        #map { width: 100%; height: 100%; }
        #panel { flex: 4; padding: 0; overflow-y: auto; background: #fff; min-width: 320px; display: flex; flex-direction: column; }
        .view-container { padding: 15px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box; }

        /* ãƒ›ãƒ¼ãƒ ç”»é¢ */
        .home-title { font-size: 1.5rem; color: #1a73e8; text-align: center; margin: 30px 0; }
        .new-plan-btn { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 30px; }
        .saved-list-title { font-size: 1rem; color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px; }
        .saved-plans-list { list-style: none; padding: 0; margin: 0; }
        .saved-plan-card { background: white; border: 1px solid #ddd; border-left: 5px solid #34a853; padding: 15px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .plan-delete { color: #ea4335; cursor: pointer; padding: 5px; font-size: 1.2rem; }

        /* ç·¨é›†ç”»é¢ */
        .header-area { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1a73e8; padding-bottom: 5px; margin-bottom: 10px; }
        .home-btn { background: #fff; border: 1px solid #ddd; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #666; }
        
        .day-tabs { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .day-tab { padding: 6px 12px; font-size: 0.9rem; border: 1px solid #ddd; border-radius: 4px 4px 0 0; background: #f8f9fa; cursor: pointer; white-space: nowrap; }
        .day-tab.active { background: #1a73e8; color: white; border-color: #1a73e8; font-weight: bold; }
        .add-day-btn { padding: 6px 10px; cursor: pointer; background: #eee; border: none; border-radius: 4px; font-weight: bold; }

        .config-area { display: flex; justify-content: space-between; align-items: center; background: #e8f0fe; padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9rem; }
        .charts-wrapper { display: flex; justify-content: space-around; height: 100px; margin-bottom: 10px; gap: 5px; flex-shrink: 0; }
        .chart-box { flex: 1; position: relative; }
        
        .input-group { background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #eee; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .row { display: flex; gap: 5px; align-items: center; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; flex: 1; }
        button.add-btn { padding: 10px; background-color: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* ãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« (ãƒ¡ãƒ¢æ©Ÿèƒ½è¿½åŠ ) */
        #placeList { list-style: none; padding: 0; margin: 0; flex: 1; overflow-y: auto; }
        li { margin-bottom: 5px; padding: 10px; border-radius: 4px; font-size: 0.9rem; }
        
        /* æ»åœ¨ã‚¢ã‚¤ãƒ†ãƒ  */
        .place-item { background: #fff; border-left: 5px solid #1a73e8; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; cursor: grab; position: relative; }
        
        /* ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸Šæ®µï¼ˆåå‰ã‚„ãƒœã‚¿ãƒ³ï¼‰ */
        .item-top { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        
        /* â˜… ãƒ¡ãƒ¢è¡¨ç¤ºã‚¨ãƒªã‚¢ (ãƒ›ãƒãƒ¼æ™‚ã®ã¿è¡¨ç¤º) */
        .item-memo-box {
            display: none; /* æœ€åˆã¯éš ã™ */
            background-color: #fffde7; /* è–„ã„é»„è‰² */
            border: 1px solid #fbc02d;
            color: #555;
            font-size: 0.85rem;
            padding: 6px 10px;
            margin-top: 5px;
            border-radius: 4px;
            white-space: pre-wrap; /* æ”¹è¡Œã‚’åæ˜  */
        }
        /* ãƒã‚¦ã‚¹ãŒä¹—ã£ãŸã‚‰è¡¨ç¤º */
        .place-item:hover .item-memo-box { display: block; }

        .move-item { background: #e8f0fe; color: #1a73e8; font-size: 0.85rem; border: 1px dashed #1a73e8; text-align: center; pointer-events: none; }
        
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 2px 5px; margin-left: 5px; }
        .btn-memo { color: #ccc; transition: 0.3s; }
        .btn-memo.has-memo { color: #fbc02d; } /* ãƒ¡ãƒ¢ã‚ã‚Šãªã‚‰é»„è‰² */
        .btn-del { color: #ea4335; }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (Step 8 è¿½åŠ ) --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; border-radius: 8px; width: 320px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .modal-header { font-weight: bold; font-size: 1.1rem; color: #333; }
        .modal-textarea { width: 100%; height: 120px; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; resize: none; font-family: inherit; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-cancel { background: #ddd; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .btn-save { background: #1a73e8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        
        /* æ¦‚è¦ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .summary-day { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .summary-day-title { font-weight: bold; color: #1a73e8; background: #e8f0fe; padding: 5px; border-radius: 4px; margin-bottom: 5px; }
        .summary-memo { color: #666; font-size: 0.8rem; background: #f9f9f9; padding: 2px 6px; border-radius: 4px; margin-left: 10px; }
    </style>
</head>
<body>

<div id="map-container"><div id="map"></div></div>

<div id="panel">
    
    <div id="home-view" class="view-container">
        <h1 class="home-title">ğŸŒ æ—…ã®ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
        <button class="new-plan-btn" onclick="startNewPlan()">ï¼‹ æ–°ã—ã„æ—…ã‚’è¨ˆç”»ã™ã‚‹</button>
        <div class="saved-list-title">ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ (ç«¯æœ«å†…)</div>
        <ul id="saved-plans-list" class="saved-plans-list"></ul>
    </div>

    <div id="planner-view" class="view-container" style="display: none;">
        <div class="header-area">
            <button class="home-btn" onclick="goHome()">ğŸ  ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
            <div style="display:flex; gap:10px;">
                <button onclick="showSummary()" style="background:#1a73e8; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ğŸ“‹ å…¨æ—¥ç¨‹</button>
                <button onclick="saveTripLocal()" style="background:#34a853; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>

        <div class="day-tabs" id="dayTabs"></div>

        <div class="config-area">
            <div>å‡ºç™º: <input type="time" id="startTime" value="09:00" onchange="updateStartTime()"></div>
        </div>

        <div class="charts-wrapper">
            <div class="chart-box"><canvas id="chartAM"></canvas></div>
            <div class="chart-box"><canvas id="chartPM"></canvas></div>
        </div>
        
        <div class="input-group">
            <input type="text" id="placeName" placeholder="ğŸ” å ´æ‰€ã‚’æ¤œç´¢">
            <div class="row">
                <select id="travelMode">
                    <option value="DRIVING">ğŸš— è»Š</option>
                    <option value="TRANSIT">ğŸšƒ é›»è»Š</option>
                    <option value="WALKING">ğŸš¶ å¾’æ­©</option>
                </select>
                <input type="number" id="stayTime" placeholder="æ»åœ¨(åˆ†)" value="60">
            </div>
            <button class="add-btn" onclick="addLocation()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
        </div>

        <ul id="placeList"></ul>
    </div>
</div>

<div id="memoModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">ğŸ“ ãƒ¡ãƒ¢ç·¨é›†</div>
        <textarea id="memoInput" class="modal-textarea" placeholder="ãŠåœŸç”£ãƒªã‚¹ãƒˆã‚„é›†åˆå ´æ‰€ãªã©ã‚’å…¥åŠ›..."></textarea>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeMemoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn-save" onclick="saveMemo()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="summaryModal" class="modal-overlay">
    <div class="modal-box" style="width: 400px; max-height: 85vh;">
        <div class="modal-header">
            <span>ğŸ“‹ å…¨æ—¥ç¨‹æ¦‚è¦</span>
            <button onclick="window.print()" style="padding:5px 10px; font-size:0.8rem; cursor:pointer;">ğŸ–¨ å°åˆ·</button>
        </div>
        <div id="summaryContent" style="overflow-y:auto; flex:1; border-top:1px solid #eee; padding-top:10px;"></div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="document.getElementById('summaryModal').style.display='none'">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<script>
    let map, geocoder, directionsService, chartAM, chartPM, sortable;
    let routeRenderers = [], markers = [];
    window.currentLatLng = null;
    let editingMemoId = null; // â˜… ç·¨é›†ä¸­ã®ãƒ¡ãƒ¢IDã‚’è¨˜æ†¶ã™ã‚‹å¤‰æ•°

    let tripData = { days: [ [] ], startTimes: ["09:00"] };
    let currentDayIndex = 0;
    let currentPlanName = "";

    function initMap() {
        geocoder = new google.maps.Geocoder();
        directionsService = new google.maps.DirectionsService();
        map = new google.maps.Map(document.getElementById("map"), { zoom: 13, center: { lat: 35.6812, lng: 139.7671 } });

        const input = document.getElementById("placeName");
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);

        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) { alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
            map.setCenter(place.geometry.location); map.setZoom(15);
            new google.maps.Marker({ position: place.geometry.location, map: map });
            
            currentPlace = {
                id: Date.now(),
                name: place.name || place.formatted_address,
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
            };
        });

        initCharts();
        initSortable();
        showHome();
    }

    // --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ---
    function showHome() {
        document.getElementById("home-view").style.display = "flex";
        document.getElementById("planner-view").style.display = "none";
        clearMapOverlays();
        renderSavedPlansList();
    }
    function showPlanner() {
        document.getElementById("home-view").style.display = "none";
        document.getElementById("planner-view").style.display = "flex";
        if(chartAM) chartAM.resize();
        if(chartPM) chartPM.resize();
        renderTabs();
        document.getElementById("startTime").value = tripData.startTimes[currentDayIndex] || "09:00";
        refreshAll();
    }
    function startNewPlan() {
        tripData = { days: [ [] ], startTimes: ["09:00"] };
        currentDayIndex = 0; currentPlanName = "";
        showPlanner();
    }
    function goHome() { if(confirm("ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ\nï¼ˆæœªä¿å­˜ã¯æ¶ˆãˆã¾ã™ï¼‰")) showHome(); }

    // --- ãƒ‡ãƒ¼ã‚¿æ“ä½œ ---
    function getCurrentList() { return tripData.days[currentDayIndex]; }

    function renderTabs() {
        const container = document.getElementById("dayTabs"); container.innerHTML = "";
        tripData.days.forEach((_, index) => {
            const btn = document.createElement("div");
            btn.className = `day-tab ${index === currentDayIndex ? 'active' : ''}`;
            btn.innerText = `Day ${index + 1}`;
            btn.onclick = () => switchDay(index);
            container.appendChild(btn);
        });
        const addBtn = document.createElement("button");
        addBtn.className = "add-day-btn"; addBtn.innerText = "ï¼‹";
        addBtn.onclick = () => { tripData.days.push([]); tripData.startTimes.push("09:00"); switchDay(tripData.days.length - 1); };
        container.appendChild(addBtn);
    }
    function switchDay(index) {
        currentDayIndex = index; renderTabs();
        document.getElementById("startTime").value = tripData.startTimes[index] || "09:00";
        refreshAll();
    }
    function updateStartTime() {
        tripData.startTimes[currentDayIndex] = document.getElementById("startTime").value;
        refreshAll();
    }

    async function addLocation() {
        if (!currentPlace) { alert("å ´æ‰€ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„"); return; }
        const mode = document.getElementById("travelMode").value;
        const stayTime = document.getElementById("stayTime").value;
        // â˜… memo: "" ã‚’è¿½åŠ ã—ã¦åˆæœŸåŒ–
        getCurrentList().push({ ...currentPlace, mode: mode, stayTime: parseInt(stayTime), memo: "" });
        document.getElementById("placeName").value = "";
        currentPlace = null;
        await refreshAll();
    }

    window.deleteItem = (id) => {
        getCurrentList().splice(getCurrentList().findIndex(d => d.id === id), 1);
        refreshAll();
    };

    // --- â˜… ãƒ¡ãƒ¢æ©Ÿèƒ½ (Step 8 è¿½åŠ ) ---
    window.openMemoModal = (id) => {
        const item = getCurrentList().find(d => d.id === id);
        if(!item) return;
        editingMemoId = id;
        document.getElementById('memoInput').value = item.memo || "";
        document.getElementById('memoModal').style.display = 'flex';
        document.getElementById('memoInput').focus();
    };
    
    window.closeMemoModal = () => {
        document.getElementById('memoModal').style.display = 'none';
        editingMemoId = null;
    };
    
    window.saveMemo = () => {
        if(editingMemoId === null) return;
        const item = getCurrentList().find(d => d.id === editingMemoId);
        if(item) {
            item.memo = document.getElementById('memoInput').value;
            refreshAll(); // ç”»é¢æ›´æ–°ã—ã¦ãƒ¡ãƒ¢ã‚’è¡¨ç¤ºã«åæ˜ 
        }
        closeMemoModal();
    };

    // --- å…¨ä½“æ›´æ–° ---
    async function refreshAll() {
        const listEl = document.getElementById("placeList");
        listEl.innerHTML = "";
        clearMapOverlays();

        const currentList = getCurrentList();
        const timeStr = tripData.startTimes[currentDayIndex];
        const [startH, startM] = timeStr.split(':').map(Number);
        let currentTimeMin = startH * 60 + startM;
        const chartSegments = [{ duration: currentTimeMin, color: 'transparent' }];

        currentList.forEach((item, index) => {
            markers.push(new google.maps.Marker({ position: { lat: item.lat, lng: item.lng }, map: map, label: (index + 1).toString() }));
        });

        for (let i = 0; i < currentList.length; i++) {
            const item = currentList[i];
            let moveTime = 0;

            if (i > 0) {
                const prev = currentList[i - 1];
                moveTime = await calculateRoute(prev, item);
                const moveLi = document.createElement("li");
                moveLi.className = "move-item"; 
                moveLi.innerText = `â¬‡ï¸ ç§»å‹•: ${moveTime}åˆ† â¬‡ï¸`;
                listEl.appendChild(moveLi);
                currentTimeMin += moveTime;
                chartSegments.push({ duration: moveTime, color: '#ff9800' });
            }

            const stay = (i === 0 && currentList.length > 1) ? 0 : item.stayTime;
            item.displayStartTime = formatTime(currentTimeMin);
            item.displayEndTime = formatTime(currentTimeMin + stay);

            // â˜… ãƒ¡ãƒ¢è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
            const hasMemo = item.memo && item.memo.length > 0;
            const memoIconClass = hasMemo ? "btn-icon btn-memo has-memo" : "btn-icon btn-memo";
            // ãƒ¡ãƒ¢ãŒã‚ã‚‹å ´åˆã®ã¿ã€divè¦ç´ ã‚’ä½œæˆï¼ˆCSSã§ãƒ›ãƒãƒ¼æ™‚ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
            const memoBoxHtml = hasMemo ? `<div class="item-memo-box">ğŸ“ ${item.memo}</div>` : "";

            const placeLi = document.createElement("li");
            placeLi.className = "place-item";
            placeLi.setAttribute("data-id", item.id);
            placeLi.innerHTML = `
                <div class="item-top">
                    <div style="flex:1;">
                        <strong>${item.name}</strong><br>
                        <span style="font-size:0.8rem; color:#666;">${item.displayStartTime} - ${item.displayEndTime} (æ»åœ¨${stay}åˆ†)</span>
                    </div>
                    <div>
                        <button class="${memoIconClass}" onclick="openMemoModal(${item.id})">ğŸ“</button>
                        <button class="btn-icon btn-del" onclick="deleteItem(${item.id})">ğŸ—‘</button>
                    </div>
                </div>
                ${memoBoxHtml} `;
            listEl.appendChild(placeLi);

            currentTimeMin += stay;
            chartSegments.push({ duration: stay, color: '#4285f4' });
        }
        updateClockCharts(chartSegments);
    }

    function calculateRoute(start, end) {
        return new Promise(resolve => {
            directionsService.route({
                origin: { lat: start.lat, lng: start.lng },
                destination: { lat: end.lat, lng: end.lng },
                travelMode: google.maps.TravelMode[end.mode]
            }, (res, status) => {
                if (status === 'OK') {
                    const renderer = new google.maps.DirectionsRenderer({
                        map: map, directions: res, suppressMarkers: true,
                        polylineOptions: { strokeColor: '#1a73e8', strokeWeight: 5, strokeOpacity: 0.6 }
                    });
                    routeRenderers.push(renderer);
                    resolve(Math.ceil(res.routes[0].legs[0].duration.value / 60));
                } else { resolve(15); }
            });
        });
    }

    function initSortable() {
        sortable = new Sortable(document.getElementById('placeList'), {
            animation: 150, filter: '.move-item', 
            onEnd: () => {
                const newOrder = [];
                const currentList = getCurrentList();
                document.querySelectorAll('.place-item').forEach(el => {
                    const id = parseFloat(el.getAttribute('data-id'));
                    const found = currentList.find(d => d.id === id);
                    if (found) newOrder.push(found);
                });
                tripData.days[currentDayIndex] = newOrder;
                refreshAll();
            }
        });
    }
    function initCharts() {
        const config = { type: 'pie', data: { datasets: [{ data: [], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, rotation: 0, circumference: 360, events: [], plugins: { legend: { display: false }, tooltip: { enabled: false } } } };
        chartAM = new Chart(document.getElementById('chartAM'), JSON.parse(JSON.stringify(config)));
        chartPM = new Chart(document.getElementById('chartPM'), JSON.parse(JSON.stringify(config)));
    }
    function updateClockCharts(segments) {
        const amData=[], amColors=[], pmData=[], pmColors=[]; let current=0;
        segments.forEach(seg => {
            if(seg.duration<=0) return;
            const start=current; const end=current+seg.duration;
            if(start<720) { amData.push(Math.min(end,720)-start); amColors.push(seg.color); }
            if(end>720) { const pmStart=Math.max(start,720); const dur=Math.min(end,1440)-pmStart; if(dur>0){ pmData.push(dur); pmColors.push(seg.color); } }
            current+=seg.duration;
        });
        if(current<1440) {
            if(current<720) { amData.push(720-current); amColors.push('#f0f0f0'); pmData.push(720); pmColors.push('#f0f0f0'); } else { pmData.push(1440-current); pmColors.push('#f0f0f0'); }
        }
        chartAM.data.datasets[0].data=amData; chartAM.data.datasets[0].backgroundColor=amColors; chartAM.update();
        chartPM.data.datasets[0].data=pmData; chartPM.data.datasets[0].backgroundColor=pmColors; chartPM.update();
    }
    function formatTime(min) {
        let h = Math.floor(min / 60) % 24; let m = min % 60;
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }
    
    function clearMapOverlays() { routeRenderers.forEach(r => r.setMap(null)); routeRenderers=[]; markers.forEach(m => m.setMap(null)); markers=[]; }

    function showSummary() {
        const content = document.getElementById("summaryContent"); content.innerHTML = "";
        tripData.days.forEach((dayList, i) => {
            let html = `<div class="summary-day"><div class="summary-day-title">Day ${i+1}</div>`;
            if(dayList.length===0) html+=`<div style="padding:10px;color:#999">(äºˆå®šãªã—)</div>`;
            dayList.forEach(item => { 
                const memoHtml = item.memo ? `<span class="summary-memo">ğŸ“ ${item.memo}</span>` : "";
                html += `<div style="padding:5px; border-bottom:1px solid #f0f0f0;"><strong>${item.name}</strong> (${item.displayStartTime || '--'} - ${item.displayEndTime || '--'}) ${memoHtml}</div>`; 
            });
            html += `</div>`; content.innerHTML += html;
        });
        document.getElementById("summaryModal").style.display = "flex";
    }

    function saveTripLocal() {
        let name = currentPlanName || prompt("ãƒ—ãƒ©ãƒ³åã‚’å…¥åŠ›:", "æ±äº¬æ—…è¡Œ");
        if (!name) return;
        currentPlanName = name;
        const saveData = { tripData: tripData, savedAt: new Date().toISOString() };
        let allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        allSaves[name] = saveData;
        localStorage.setItem("travel_planner_saves", JSON.stringify(allSaves));
        alert("ä¿å­˜ã—ã¾ã—ãŸ");
    }
    function renderSavedPlansList() {
        const ul = document.getElementById('saved-plans-list'); ul.innerHTML = '';
        const allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        Object.keys(allSaves).reverse().forEach(name => {
            const li = document.createElement('li'); li.className = 'saved-plan-card';
            li.innerHTML = `<div class="plan-info" onclick="loadLocal('${name}')" style="flex:1;"><h3>${name}</h3></div><div class="plan-delete" onclick="deleteLocal('${name}')">ğŸ—‘</div>`;
            ul.appendChild(li);
        });
    }
    window.loadLocal = (name) => {
        const allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        if (allSaves[name]) { tripData = allSaves[name].tripData; currentDayIndex = 0; currentPlanName = name; showPlanner(); }
    };
    window.deleteLocal = (name) => {
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            let allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
            delete allSaves[name]; localStorage.setItem("travel_planner_saves", JSON.stringify(allSaves)); renderSavedPlansList();
        }
    };

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDaOSP3v96sTjeE9YDKl1AqURjCA8jr7Ro&callback=initMap&libraries=places" async defer></script>

</body>
</html>
