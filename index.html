<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…ã®ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ v33 (Mobile)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        /* --- åŸºæœ¬ãƒªã‚»ãƒƒãƒˆ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f0f2f5; overflow: hidden; }

        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (PCãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: å·¦å³) --- */
        #map-container { flex: 6; border-right: 2px solid #ddd; position: relative; height: 100%; }
        #map { width: 100%; height: 100%; }
        #panel { flex: 4; padding: 0; overflow-y: auto; background: white; display: flex; flex-direction: column; min-width: 320px; position: relative; height: 100%; }
        .view-container { padding: 15px; display: flex; flex-direction: column; height: 100%; }

        /* --- ã‚¹ãƒãƒ›å¯¾å¿œ (ç”»é¢å¹…768pxä»¥ä¸‹) --- */
        @media (max-width: 768px) {
            body { flex-direction: column; } /* ä¸Šä¸‹ã«ä¸¦ã¹ã‚‹ */
            #map-container { flex: none; height: 35vh; border-right: none; border-bottom: 1px solid #ddd; } /* åœ°å›³ã¯ä¸Š35% */
            #panel { flex: 1; height: 65vh; } /* ãƒªã‚¹ãƒˆã¯ä¸‹65% */
            
            /* ã‚¹ãƒãƒ›ã§ã®ãƒ¡ãƒ¢è¡¨ç¤º: ãƒ›ãƒãƒ¼ã§ããªã„ã®ã§å¸¸æ™‚è¡¨ç¤º */
            .item-memo-box { display: block !important; margin-top: 4px; }
            
            /* æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
            input, select, button, .day-tab { font-size: 16px !important; } /* 16pxã«ã™ã‚‹ã¨iOSã§ã‚ºãƒ¼ãƒ ã•ã‚Œãªã„ */
            .btn-icon { padding: 8px; font-size: 1.2rem; } /* ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã—ã‚„ã™ã */
        }

        /* --- ãƒ›ãƒ¼ãƒ ç”»é¢ --- */
        .home-title { font-size: 1.5rem; color: #1a73e8; text-align: center; margin: 30px 0; }
        .new-plan-btn { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(26, 115, 232, 0.3); }
        .new-plan-btn:active { transform: scale(0.98); }
        .saved-list-title { font-size: 1rem; color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px; }
        .saved-plans-list { list-style: none; padding: 0; margin: 0; }
        .saved-plan-card { background: white; border: 1px solid #ddd; border-left: 5px solid #34a853; padding: 15px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; touch-action: manipulation; }
        .plan-info h3 { margin: 0; font-size: 1rem; color: #333; }
        .plan-delete { color: #ea4335; padding: 10px; font-size: 1.2rem; }

        /* --- ç·¨é›†ç”»é¢ãƒ‘ãƒ¼ãƒ„ --- */
        .header-area { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; margin-bottom: 10px; flex-shrink: 0; }
        .home-btn { background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: #666; }
        .save-btn { font-size: 0.9rem; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none; background: #1a73e8; color: white; font-weight: bold; }

        .day-tabs { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #ddd; flex-shrink: 0; -webkit-overflow-scrolling: touch; }
        .day-tab { padding: 8px 15px; font-size: 0.9rem; border: 1px solid #ddd; border-radius: 4px 4px 0 0; background: #f8f9fa; cursor: pointer; white-space: nowrap; }
        .day-tab.active { background: #1a73e8; color: white; border-color: #1a73e8; font-weight: bold; }
        .add-day-btn { padding: 8px 15px; cursor: pointer; background: #eee; border: none; border-radius: 4px; font-weight: bold; }

        .config-area { display: flex; justify-content: space-between; align-items: center; background: #e8f0fe; padding: 10px; border-radius: 6px; margin-bottom: 10px; flex-shrink: 0; font-size: 0.9rem; }
        .btn-geo { font-size: 0.85rem; padding: 6px 10px; background: #fff; border: 1px solid #1a73e8; color: #1a73e8; border-radius: 4px; cursor: pointer; }

        .input-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #eee; flex-shrink: 0; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
        button.add-btn { padding: 12px; background-color: #1a73e8; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        
        /* ãƒªã‚¹ãƒˆ */
        #scheduleList { list-style: none; padding: 0; margin: 0; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 50px; }
        li { margin-bottom: 8px; padding: 10px; border-radius: 4px; font-size: 0.9rem; }
        .place-item { background: #fff; border-left: 5px solid #1a73e8; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; position: relative; }
        .move-item { background: #e8f0fe; color: #1a73e8; font-size: 0.85rem; border: 1px dashed #1a73e8; text-align: center; pointer-events: none; }
        
        .item-top { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        .item-btns { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; }
        .btn-memo { color: #ccc; }
        .btn-memo.has-memo { color: #fbc02d; }
        .btn-del { color: #ea4335; }

        /* PCã®ã¿ãƒ›ãƒãƒ¼ã§è¡¨ç¤º */
        @media (min-width: 769px) {
            .item-memo-box { display: none; }
            .place-item:hover .item-memo-box { display: block; }
        }
        /* å…±é€šãƒ¡ãƒ¢ã‚¹ã‚¿ã‚¤ãƒ« */
        .item-memo-box { background-color: #fffde7; border: 1px solid #fbc02d; color: #555; font-size: 0.85rem; padding: 8px; margin-top: 5px; border-radius: 4px; white-space: pre-wrap; }

        .tiny-input { width: 50px; padding: 4px; font-size: 0.9rem; border: 1px solid #ccc; border-radius: 3px; text-align: right; margin: 0 2px; }

        .charts-wrapper { display: flex; height: 100px; margin-bottom: 10px; gap: 5px; flex-shrink: 0; }
        .chart-box { flex: 1; position: relative; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .modal-header { font-weight: bold; font-size: 1.1rem; color: #333; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .modal-content { overflow-y: auto; flex: 1; border-top: 1px solid #eee; padding-top: 10px; }
        .modal-buttons { margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-textarea { width: 100%; height: 120px; padding: 10px; font-size: 1rem; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; resize: none; margin-top: 10px; font-family: inherit; }
        
        .summary-day { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .summary-day-title { font-weight: bold; color: #1a73e8; background: #e8f0fe; padding: 8px; border-radius: 4px; margin-bottom: 5px; }
        .summary-memo { color: #666; font-size: 0.85rem; background: #f9f9f9; padding: 4px 8px; border-radius: 4px; display: block; margin-top: 4px; }
    </style>
</head>
<body>

<div id="map-container"><div id="map"></div></div>

<div id="panel">
    <div id="home-view" class="view-container">
        <h1 class="home-title">ğŸŒ æ—…ã®ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
        <button class="new-plan-btn" onclick="startNewPlan()">ï¼‹ æ–°ã—ã„æ—…ã‚’è¨ˆç”»ã™ã‚‹</button>
        <div class="saved-list-title">ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ (ç«¯æœ«å†…)</div>
        <ul id="saved-plans-list" class="saved-plans-list"></ul>
    </div>

    <div id="planner-view" class="view-container" style="display: none;">
        <div class="header-area">
            <button class="home-btn" onclick="goHome()">ğŸ  ãƒ›ãƒ¼ãƒ </button>
            <div style="display:flex; gap:10px;">
                <button onclick="showSummary()" style="background:#1a73e8; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">ğŸ“‹ å…¨æ—¥ç¨‹</button>
                <button onclick="saveTripLocal()" style="background:#34a853; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>

        <div class="day-tabs" id="dayTabs"></div>

        <div class="config-area">
            <div>å‡ºç™º: <input type="time" id="startTime" value="09:00" onchange="updateStartTime()"></div>
            <button class="btn-geo" onclick="addCurrentLocation()">ğŸ“ ç¾åœ¨åœ°</button>
        </div>

        <div class="charts-wrapper">
            <div class="chart-box"><canvas id="chartAM"></canvas></div>
            <div class="chart-box"><canvas id="chartPM"></canvas></div>
        </div>
        
        <div class="input-group">
            <input type="text" id="placeName" placeholder="ğŸ” ç›®çš„åœ°ã‚’æ¤œç´¢">
            <div style="display:flex; gap:5px;">
                <select id="travelMode" style="flex:1;">
                    <option value="DRIVING">ğŸš— è»Š</option>
                    <option value="TRANSIT">ğŸšƒ é›»è»Š</option>
                    <option value="WALKING">ğŸš¶ å¾’æ­©</option>
                </select>
                <input type="number" id="stayTime" placeholder="æ»åœ¨(åˆ†)" value="60" style="width: 70px;">
            </div>
            <button class="add-btn" onclick="addLocation()">è¿½åŠ </button>
        </div>

        <ul id="scheduleList"></ul>
    </div>
</div>

<div id="memoModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">ğŸ“ ãƒ¡ãƒ¢ç·¨é›†</div>
        <textarea id="memoInput" class="modal-textarea" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
        <div class="modal-buttons">
            <button class="save-btn" style="background:#ddd; color:#333;" onclick="closeMemoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="save-btn" onclick="saveMemo()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="summaryModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <span>ğŸ“‹ å…¨æ—¥ç¨‹æ¦‚è¦</span>
            <button onclick="window.print()" style="padding:5px 10px; font-size:0.8rem; background:#fff; border:1px solid #ccc; cursor:pointer;">ğŸ–¨ å°åˆ·</button>
        </div>
        <div id="summaryContent" class="modal-content"></div>
        <div class="modal-buttons">
            <button class="save-btn" onclick="document.getElementById('summaryModal').style.display='none'">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<script>
    let map, geocoder, directionsService, chartAM, chartPM, sortable;
    let routeRenderers = [], markers = [];
    window.currentLatLng = null;
    let editingMemoId = null;
    
    let tripData = { days: [ [] ], startTimes: ["09:00"] };
    let currentDayIndex = 0;
    let currentPlanName = "";

    function initMap() {
        geocoder = new google.maps.Geocoder();
        directionsService = new google.maps.DirectionsService();
        map = new google.maps.Map(document.getElementById("map"), { zoom: 13, center: {lat: 35.6812, lng: 139.7671} });

        const input = document.getElementById("placeName");
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);
        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) { alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
            map.setCenter(place.geometry.location); map.setZoom(15);
            window.currentLatLng = place.geometry.location;
            document.getElementById('placeName').value = place.name || place.formatted_address;
        });

        map.addListener("click", (e) => {
            window.currentLatLng = e.latLng;
            geocoder.geocode({ location: e.latLng }, (results, status) => {
                if (status === "OK" && results[0]) document.getElementById('placeName').value = results[0].formatted_address;
            });
            new google.maps.Marker({ position: e.latLng, map: map, title: "é¸æŠä½ç½®" });
        });

        initCharts();
        initSortable();
        showHome();
    }

    // --- ç”»é¢é·ç§» ---
    function showHome() {
        document.getElementById('home-view').style.display = 'flex';
        document.getElementById('planner-view').style.display = 'none';
        clearMapOverlays();
        renderSavedPlansList();
    }
    function showPlanner() {
        document.getElementById('home-view').style.display = 'none';
        document.getElementById('planner-view').style.display = 'flex';
        if(chartAM) chartAM.resize(); if(chartPM) chartPM.resize();
        renderTabs();
        document.getElementById('startTime').value = tripData.startTimes[currentDayIndex];
        refreshSchedule();
    }
    function startNewPlan() {
        tripData = { days: [ [] ], startTimes: ["09:00"] };
        currentDayIndex = 0; currentPlanName = "";
        showPlanner();
    }
    function goHome() { if(confirm("ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ\n(ä¿å­˜ã—ã¦ã„ãªã„å†…å®¹ã¯ç ´æ£„ã•ã‚Œã¾ã™)")) showHome(); }

    // --- ãƒ‡ãƒ¼ã‚¿æ“ä½œ ---
    function getCurrentDayList() { return tripData.days[currentDayIndex]; }

    function renderTabs() {
        const container = document.getElementById("dayTabs"); container.innerHTML = "";
        tripData.days.forEach((_, index) => {
            const btn = document.createElement("div");
            btn.className = `day-tab ${index === currentDayIndex ? 'active' : ''}`;
            btn.innerText = `Day ${index + 1}`;
            btn.onclick = () => switchDay(index);
            container.appendChild(btn);
        });
        const addBtn = document.createElement("button");
        addBtn.className = "add-day-btn"; addBtn.innerText = "ï¼‹";
        addBtn.onclick = () => { tripData.days.push([]); tripData.startTimes.push("09:00"); switchDay(tripData.days.length - 1); };
        container.appendChild(addBtn);
    }
    function switchDay(index) {
        currentDayIndex = index; renderTabs();
        document.getElementById("startTime").value = tripData.startTimes[index] || "09:00";
        refreshSchedule();
    }
    function updateStartTime() {
        tripData.startTimes[currentDayIndex] = document.getElementById("startTime").value;
        refreshSchedule();
    }

    window.updateStayTime = (id, newVal) => {
        const item = getCurrentDayList().find(d => d.id === id);
        if(item) {
            item.stayTime = parseInt(newVal) || 0;
            refreshSchedule();
        }
    };

    async function addLocation() {
        if (!window.currentLatLng) { alert("å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
        const name = document.getElementById('placeName').value;
        const time = parseInt(document.getElementById('stayTime').value);
        const mode = document.getElementById('travelMode').value;
        const latLngObj = window.currentLatLng.toJSON ? window.currentLatLng.toJSON() : window.currentLatLng;
        getCurrentDayList().push({ id: Date.now(), name: name, stayTime: time, latLng: latLngObj, mode: mode, isMove: false, memo: "" });
        await refreshSchedule();
        document.getElementById('placeName').value = ''; window.currentLatLng = null;
    }

    function addCurrentLocation() {
        if(!navigator.geolocation) { alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“"); return; }
        navigator.geolocation.getCurrentPosition(pos => {
            const latLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            map.setCenter(latLng);
            getCurrentDayList().push({ id: Date.now(), name: "ğŸ“ ç¾åœ¨åœ°", stayTime: 0, latLng: latLng, mode: "DRIVING", isMove: false, memo: "" });
            refreshSchedule();
        }, () => { alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"); });
    }

    window.openMemoModal = (id) => {
        const item = getCurrentDayList().find(d => d.id === id);
        if(!item) return;
        editingMemoId = id;
        document.getElementById('memoInput').value = item.memo || "";
        document.getElementById('memoModal').style.display = 'flex';
        document.getElementById('memoInput').focus();
    };
    window.closeMemoModal = () => { document.getElementById('memoModal').style.display = 'none'; editingMemoId = null; };
    window.saveMemo = () => {
        if(editingMemoId === null) return;
        const item = getCurrentDayList().find(d => d.id === editingMemoId);
        if(item) { item.memo = document.getElementById('memoInput').value; refreshSchedule(); }
        closeMemoModal();
    };

    // --- è¨ˆç®— ---
    async function refreshSchedule() {
        clearMapOverlays();
        const list = getCurrentDayList();
        const timeStr = tripData.startTimes[currentDayIndex] || "09:00";
        const [h, m] = timeStr.split(':').map(Number);
        let currentTimeMin = h * 60 + m;
        const displayList = [];
        const chartSegments = [{ duration: currentTimeMin, color: 'transparent' }];

        list.forEach((item, idx) => {
            markers.push(new google.maps.Marker({ position: item.latLng, map: map, label: (idx+1).toString(), title: item.name }));
        });

        for (let i = 0; i < list.length; i++) {
            const item = list[i];
            let moveTime = 0;
            if (i > 0) {
                const prev = list[i-1];
                moveTime = await calculateRoute(prev.latLng, item.latLng, item.mode);
                displayList.push({ name: `ç§»å‹• (${item.mode})`, time: moveTime, isMove: true });
                chartSegments.push({ duration: moveTime, color: '#ff9800' });
                currentTimeMin += moveTime;
            }
            const stay = (i === 0 && list.length > 1) ? 0 : item.stayTime;
            item.displayStartTime = formatTime(currentTimeMin);
            item.displayEndTime = formatTime(currentTimeMin + stay);

            displayList.push({ ...item, startTime: item.displayStartTime, endTime: item.displayEndTime });
            chartSegments.push({ duration: stay, color: '#4285f4' });
            currentTimeMin += stay;
        }
        renderList(displayList);
        updateClockCharts(chartSegments);
    }

    function calculateRoute(start, end, mode) {
        return new Promise(resolve => {
            directionsService.route({ origin: start, destination: end, travelMode: google.maps.TravelMode[mode] }, (res, status) => {
                if (status === 'OK') {
                    const renderer = new google.maps.DirectionsRenderer({ map: map, directions: res, suppressMarkers: true, polylineOptions: { strokeColor: mode==='WALKING'?'#4caf50':'#1a73e8', strokeWeight: 5, strokeOpacity: 0.6 } });
                    routeRenderers.push(renderer);
                    resolve(Math.ceil(res.routes[0].legs[0].duration.value / 60));
                } else { resolve(15); }
            });
        });
    }

    function renderList(list) {
        const ul = document.getElementById('scheduleList'); ul.innerHTML = '';
        list.forEach(item => {
            const li = document.createElement('li');
            li.className = `place-item ${item.isMove ? 'move-item' : ''}`;
            if (!item.isMove) li.setAttribute('data-id', item.id);

            if (item.isMove) {
                li.innerHTML = `<span>â¬‡ï¸ ç§»å‹• (${item.time}åˆ†) â¬‡ï¸</span>`;
            } else {
                const hasMemo = item.memo && item.memo.length > 0;
                const memoClass = hasMemo ? "btn-icon btn-memo has-memo" : "btn-icon btn-memo";
                // v33: ã‚¯ãƒ©ã‚¹åã ã‘æ®‹ã—ã€CSSã§è¡¨ç¤ºåˆ¶å¾¡ã™ã‚‹
                const memoBoxHtml = hasMemo ? `<div class="item-memo-box">ğŸ“ ${item.memo}</div>` : "";
                
                li.innerHTML = `
                    <div class="item-top">
                        <div style="flex:1;">
                            <strong>${item.name}</strong><br>
                            <span style="font-size:0.8rem;color:#666;">
                                ${item.startTime} - ${item.endTime} 
                                (æ»åœ¨ <input type="number" class="tiny-input" value="${item.stayTime}" onchange="updateStayTime(${item.id}, this.value)" onclick="event.stopPropagation()"> åˆ†)
                            </span>
                        </div>
                        <div class="item-btns">
                            <button class="${memoClass}" onclick="openMemoModal(${item.id})">ğŸ“</button>
                            <button class="btn-icon btn-del" onclick="deleteItem(${item.id})">ğŸ—‘</button>
                        </div>
                    </div>
                    ${memoBoxHtml}
                `;
            }
            ul.appendChild(li);
        });
    }

    window.deleteItem = (id) => {
        getCurrentDayList().splice(getCurrentDayList().findIndex(d => d.id === id), 1);
        refreshSchedule();
    };

    function saveTripLocal() {
        let name = currentPlanName || prompt("ãƒ—ãƒ©ãƒ³åã‚’å…¥åŠ›:", "æ±äº¬æ—…è¡Œ");
        if (!name) return;
        currentPlanName = name;
        const saveData = { tripData: tripData, savedAt: new Date().toISOString() };
        let allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        allSaves[name] = saveData;
        localStorage.setItem("travel_planner_saves", JSON.stringify(allSaves));
        alert("ä¿å­˜ã—ã¾ã—ãŸ");
    }
    function renderSavedPlansList() {
        const ul = document.getElementById('saved-plans-list'); ul.innerHTML = '';
        const allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        Object.keys(allSaves).reverse().forEach(name => {
            const li = document.createElement('li'); li.className = 'saved-plan-card';
            li.innerHTML = `<div class="plan-info" onclick="loadLocal('${name}')" style="flex:1;"><h3>${name}</h3></div><div class="plan-delete" onclick="deleteLocal('${name}')">ğŸ—‘</div>`;
            ul.appendChild(li);
        });
    }
    window.loadLocal = (name) => {
        const allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        if (allSaves[name]) { tripData = allSaves[name].tripData; currentDayIndex = 0; currentPlanName = name; showPlanner(); }
    };
    window.deleteLocal = (name) => {
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            let allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
            delete allSaves[name]; localStorage.setItem("travel_planner_saves", JSON.stringify(allSaves)); renderSavedPlansList();
        }
    };

    function showSummary() {
        const div = document.getElementById('summaryContent'); div.innerHTML = '';
        tripData.days.forEach((dayList, i) => {
            let html = `<div class="summary-day"><div class="summary-day-title">Day ${i+1} (å‡ºç™º: ${tripData.startTimes[i]})</div>`;
            if(dayList.length===0) html+=`<div style="padding:10px;color:#999">(äºˆå®šãªã—)</div>`;
            dayList.forEach(item => { 
                const timeStr = (item.displayStartTime) ? `${item.displayStartTime} - ${item.displayEndTime}` : "---";
                const memoHtml = (item.memo) ? `<div class="summary-memo">ğŸ“ ${item.memo}</div>` : "";
                const stayStr = (item.stayTime > 0) ? `(æ»åœ¨: ${item.stayTime}åˆ†)` : "(å‡ºç™ºåœ°)";
                html += `
                    <div style="padding:5px; border-bottom:1px solid #f0f0f0; display:flex; gap:10px;">
                        <div style="min-width:80px; color:#666; font-size:0.8rem;">${timeStr}</div>
                        <div style="flex:1;">
                            <strong>${item.name}</strong> 
                            <span style="font-size:0.8rem; color:#888; margin-left:5px;">${stayStr}</span>
                            ${memoHtml}
                        </div>
                    </div>`; 
            });
            html += `</div>`; div.innerHTML += html;
        });
        document.getElementById('summaryModal').style.display = 'flex';
    }

    function initCharts() {
        const cfg = { type: 'pie', data: { datasets: [{ data: [], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, rotation: 0, circumference: 360, events: [], plugins: { legend: { display: false }, tooltip: { enabled: false } } } };
        chartAM = new Chart(document.getElementById('chartAM'), JSON.parse(JSON.stringify(cfg)));
        chartPM = new Chart(document.getElementById('chartPM'), JSON.parse(JSON.stringify(cfg)));
    }
    function updateClockCharts(segments) {
        const amData=[], amColors=[], pmData=[], pmColors=[]; let current=0;
        segments.forEach(seg => {
            if(seg.duration<=0) return;
            const start=current; const end=current+seg.duration;
            if(start<720) { amData.push(Math.min(end,720)-start); amColors.push(seg.color); }
            if(end>720) { const pmStart=Math.max(start,720); const dur=Math.min(end,1440)-pmStart; if(dur>0){ pmData.push(dur); pmColors.push(seg.color); } }
            current+=seg.duration;
        });
        if(current<1440) {
            if(current<720) { amData.push(720-current); amColors.push('#f0f0f0'); pmData.push(720); pmColors.push('#f0f0f0'); } else { pmData.push(1440-current); pmColors.push('#f0f0f0'); }
        }
        chartAM.data.datasets[0].data=amData; chartAM.data.datasets[0].backgroundColor=amColors; chartAM.update();
        chartPM.data.datasets[0].data=pmData; chartPM.data.datasets[0].backgroundColor=pmColors; chartPM.update();
    }
    function initSortable() {
        sortable = new Sortable(document.getElementById('scheduleList'), {
            animation: 150, handle: '.place-item', 
            onEnd: async () => { 
                const list = getCurrentDayList(); const newList = [];
                document.querySelectorAll('.place-item').forEach(el => { const id=parseFloat(el.getAttribute('data-id')); const d=list.find(x=>x.id===id); if(d) newList.push(d); });
                tripData.days[currentDayIndex] = newList; await refreshSchedule(); 
            }
        });
    }
    function clearMapOverlays() { routeRenderers.forEach(r => r.setMap(null)); routeRenderers=[]; markers.forEach(m => m.setMap(null)); markers=[]; }
    function formatTime(min) { let h=Math.floor(min/60)%24; let m=min%60; return `${h}:${m.toString().padStart(2,'0')}`; }

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDaOSP3v96sTjeE9YDKl1AqURjCA8jr7Ro&callback=initMap&libraries=places" async defer></script>

</body>
</html>