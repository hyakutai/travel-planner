<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ã®ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ v21</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        /* --- Base Styles --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f0f2f5; overflow: hidden; }
        
        #map-container { flex: 0 0 60%; border-right: 2px solid #ddd; position: relative; }
        #map { width: 100%; height: 100%; }
        
        #panel { flex: 1; padding: 0; overflow-y: auto; background: white; display: flex; flex-direction: column; min-width: 320px; position: relative; }
        
        .view-container { padding: 15px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box; }
        
        /* --- Home View --- */
        .home-title { font-size: 1.5rem; color: #1a73e8; text-align: center; margin-bottom: 30px; margin-top: 20px; }
        .new-plan-btn { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(26, 115, 232, 0.3); transition: transform 0.1s; }
        .new-plan-btn:hover { background: #1557b0; transform: translateY(-2px); }
        .saved-list-title { font-size: 1rem; color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 15px; }
        .saved-plans-list { list-style: none; padding: 0; margin: 0; }
        .saved-plan-card { background: white; border: 1px solid #ddd; border-left: 5px solid #34a853; padding: 15px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; transition: box-shadow 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .saved-plan-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); background: #f9f9f9; }
        .plan-info h3 { margin: 0 0 5px 0; font-size: 1rem; color: #333; }
        .plan-date { font-size: 0.75rem; color: #888; }
        .plan-delete { color: #ea4335; cursor: pointer; padding: 5px; font-size: 1.1rem; }
        .plan-delete:hover { background: #fee; border-radius: 4px; }

        /* --- Planner View --- */
        .header-area { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1a73e8; padding-bottom: 5px; margin-bottom: 10px; }
        .home-btn { background: none; border: 1px solid #ddd; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #666; }
        .home-btn:hover { background: #f0f0f0; }
        .action-btn { font-size: 0.8rem; padding: 4px 10px; border-radius: 4px; cursor: pointer; border: 1px solid #ccc; background: #f8f9fa; margin-left: 5px; }
        .action-btn:hover { background: #e8f0fe; }
        .save-btn { font-size: 0.8rem; padding: 4px 12px; border-radius: 4px; cursor: pointer; border: none; background: #1a73e8; color: white; font-weight: bold; margin-left: 5px; }

        .day-tabs { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #ddd; }
        .day-tab { padding: 5px 10px; font-size: 0.85rem; border: 1px solid #ddd; border-radius: 4px 4px 0 0; background: #f8f9fa; cursor: pointer; white-space: nowrap; }
        .day-tab.active { background: #1a73e8; color: white; border-color: #1a73e8; font-weight: bold; }
        .add-day-btn { padding: 5px 10px; font-size: 0.85rem; cursor: pointer; background: #eee; border: none; border-radius: 4px; }

        .config-area { display: flex; justify-content: space-between; align-items: center; background: #e8f0fe; padding: 6px 10px; border-radius: 6px; margin-bottom: 10px; font-size: 0.8rem; }
        .config-row { display: flex; align-items: center; gap: 5px; }
        .config-area input { padding: 2px 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85rem; width: 70px; }
        .btn-geo { font-size: 0.75rem; padding: 3px 8px; background: #fff; border: 1px solid #1a73e8; color: #1a73e8; border-radius: 4px; cursor: pointer; }

        .charts-wrapper { display: flex; justify-content: space-around; height: 110px; margin-bottom: 15px; gap: 4px; flex-shrink: 0; }
        .chart-box { flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; max-width: 48%; }
        .chart-label { font-size: 0.7rem; font-weight: bold; color: #555; margin-bottom: 2px; }

        .input-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; border: 1px solid #eee; flex-shrink: 0; }
        input, select { padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85rem; }
        .input-row { display: flex; gap: 5px; }
        button.main-btn { padding: 8px; background-color: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.85rem; }

        #scheduleList { list-style: none; padding: 0; margin: 0; flex: 1; overflow-y: auto; }
        .schedule-item { background: white; border-left: 4px solid #1a73e8; margin-bottom: 6px; padding: 8px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .item-move { border-left-color: #ff9800; background: #fffde7; padding: 4px 8px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .item-name { font-weight: bold; font-size: 0.85rem; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 55%; }
        .item-time-info { text-align: right; font-size: 0.75rem; color: #666; }
        .edit-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; border-top: 1px dashed #eee; padding-top: 4px; }
        .edit-input { width: 50px; padding: 2px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.8rem; text-align: right; }
        .edit-select { padding: 2px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.75rem; }
        .btn-icon { cursor: pointer; font-size: 1rem; border: none; background: none; padding: 0 5px; }
        .btn-del { color: #ea4335; }
        .drag-handle { cursor: grab; color: #aaa; margin-right: 5px; font-size: 1rem; }
        
        /* Memo & Modal */
        .memo-wrapper { position: relative; display: inline-block; }
        .btn-memo { color: #ccc; transition: 0.3s; }
        .btn-memo.has-memo { color: #fbc02d; }
        .memo-tooltip { visibility: hidden; opacity: 0; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 8px 12px; position: absolute; z-index: 100; bottom: 125%; left: 50%; transform: translateX(-50%); width: max-content; max-width: 200px; font-size: 0.75rem; transition: opacity 0.2s; pointer-events: none; }
        .memo-wrapper:hover .memo-tooltip { visibility: visible; opacity: 1; }
        
        /* Generic Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; border-radius: 8px; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 10px; max-height: 80vh; }
        .modal-title { font-weight: bold; font-size: 1.1rem; color: #333; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .modal-textarea { width: 100%; height: 100px; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; resize: none; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        .btn-save { background: #1a73e8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .btn-cancel { background: #ddd; color: #333; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; }

        /* Summary Modal Specifics */
        .summary-content { overflow-y: auto; flex: 1; padding-right: 5px; }
        .summary-day { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .summary-day-title { font-weight: bold; color: #1a73e8; font-size: 1rem; margin-bottom: 8px; background: #e8f0fe; padding: 5px; border-radius: 4px; }
        .summary-item { font-size: 0.85rem; padding: 4px 0; display: flex; align-items: flex-start; gap: 5px; }
        .summary-item-bullet { color: #aaa; }
        .summary-memo { color: #666; font-size: 0.75rem; margin-left: 15px; background: #f9f9f9; padding: 2px 5px; border-radius: 3px; display: block; width: fit-content; }
    </style>
</head>
<body>

<div id="map-container"><div id="map"></div></div>

<div id="panel">
    <div id="home-view" class="view-container">
        <h1 class="home-title">ğŸŒ æ—…ã®ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>
        <button class="new-plan-btn" onclick="startNewPlan()">ï¼‹ æ–°ã—ã„æ—…ã‚’è¨ˆç”»ã™ã‚‹</button>
        <div class="saved-list-title">ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ©ãƒ³</div>
        <ul id="saved-plans-list" class="saved-plans-list"></ul>
    </div>

    <div id="planner-view" class="view-container" style="display: none;">
        <div class="header-area">
            <button class="home-btn" onclick="goHome()">ğŸ  ãƒ›ãƒ¼ãƒ </button>
            <div style="display:flex; align-items:center;">
                <button class="action-btn" onclick="showSummary()">ğŸ“‹ å…¨æ—¥ç¨‹</button>
                <button class="save-btn" onclick="saveTrip()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>

        <div class="day-tabs" id="dayTabs"></div>

        <div class="config-area">
            <div class="config-row">
                <span>å‡ºç™º:</span>
                <input type="time" id="startTime" value="09:00" onchange="updateStartTime(this.value)">
            </div>
            <button class="btn-geo" onclick="addCurrentLocation()">ğŸ“ ç¾åœ¨åœ°</button>
        </div>

        <div class="charts-wrapper">
            <div class="chart-box"><span class="chart-label">AM</span><canvas id="chartAM"></canvas></div>
            <div class="chart-box"><span class="chart-label">PM</span><canvas id="chartPM"></canvas></div>
        </div>
        
        <div class="input-group">
            <input type="text" id="placeName" placeholder="ğŸ” ç›®çš„åœ°ã‚’æ¤œç´¢">
            <div class="input-row">
                <select id="travelMode" style="flex: 1;">
                    <option value="DRIVING">ğŸš— è»Š</option>
                    <option value="TRANSIT">ğŸšƒ é›»è»Š</option>
                    <option value="WALKING">ğŸš¶ å¾’æ­©</option>
                </select>
                <input type="number" id="stayTime" placeholder="æ»åœ¨(åˆ†)" value="60" style="width: 60px;">
            </div>
            <button class="main-btn" onclick="addNewLocation()">è¿½åŠ </button>
        </div>

        <ul id="scheduleList"></ul>
    </div>
</div>

<div id="memoModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title">ğŸ“ ãƒ¡ãƒ¢ç·¨é›†</div>
        <textarea id="memoInput" class="modal-textarea" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeMemoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn-save" onclick="saveMemo()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="summaryModal" class="modal-overlay">
    <div class="modal-box" style="width: 400px; max-height: 85vh;">
        <div class="modal-title">
            <span>ğŸ“‹ å…¨æ—¥ç¨‹æ¦‚è¦</span>
            <button class="action-btn" onclick="window.print()">ğŸ–¨ å°åˆ·</button>
        </div>
        <div id="summaryContent" class="summary-content">
            </div>
        <div class="modal-buttons">
            <button class="btn-save" onclick="document.getElementById('summaryModal').style.display='none'">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<script>
// --- ç°¡æ˜“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­· ---
(function() {
    const password = "0830"; // â˜…å¥½ããªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã¦ãã ã•ã„
    let input = "";
    while (input !== password) {
        input = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
        if (input === null) { // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆ
            document.body.innerHTML = "<h1>ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ</h1>";
            throw new Error("Access Denied"); // å‡¦ç†ã‚’å¼·åˆ¶åœæ­¢
        }
    }
})();
// -----------------------

    let map, geocoder, directionsService;
    let chartAM, chartPM, sortable;
    let routeRenderers = [], markers = [];
    window.currentLatLng = null;
    let editingMemoId = null;
    let tripData = { days: [ [] ], startTimes: ["09:00"] };
    let currentDayIndex = 0;
    let currentPlanName = "";
    
    function initMap() {
        geocoder = new google.maps.Geocoder();
        directionsService = new google.maps.DirectionsService();
        map = new google.maps.Map(document.getElementById("map"), { zoom: 14, center: {lat: 35.6812, lng: 139.7671} });

        const input = document.getElementById("placeName");
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);

        autocomplete.addListener("place_changed", () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) { alert("å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
            map.setCenter(place.geometry.location);
            map.setZoom(16);
            window.currentLatLng = place.geometry.location;
            document.getElementById('placeName').value = place.name || place.formatted_address;
        });

        map.addListener("click", (e) => {
            window.currentLatLng = e.latLng;
            geocoder.geocode({ location: e.latLng }, (results, status) => {
                if (status === "OK" && results[0]) {
                    document.getElementById('placeName').value = results[0].formatted_address;
                }
            });
        });

        initCharts();
        initSortable();
        showHome();
    }

    function showHome() {
        document.getElementById('home-view').style.display = 'flex';
        document.getElementById('planner-view').style.display = 'none';
        clearMapOverlays();
        renderSavedPlansList();
    }
    function showPlanner() {
        document.getElementById('home-view').style.display = 'none';
        document.getElementById('planner-view').style.display = 'flex';
        if(chartAM) chartAM.resize();
        if(chartPM) chartPM.resize();
        renderTabs();
        document.getElementById('startTime').value = tripData.startTimes[currentDayIndex];
        refreshSchedule();
    }
    function goHome() { if (confirm("ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) showHome(); }
    function startNewPlan() {
        tripData = { days: [ [] ], startTimes: ["09:00"] };
        currentDayIndex = 0; currentPlanName = "";
        showPlanner();
    }

    // --- å…¨æ—¥ç¨‹æ¦‚è¦æ©Ÿèƒ½ ---
    window.showSummary = () => {
        const container = document.getElementById('summaryContent');
        container.innerHTML = '';

        tripData.days.forEach((dayList, idx) => {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'summary-day';
            const startTime = tripData.startTimes[idx] || "09:00";
            
            let html = `<div class="summary-day-title">Day ${idx + 1} (å‡ºç™º: ${startTime})</div>`;
            
            if (dayList.length === 0) {
                html += `<div style="color:#999; font-size:0.8rem; margin-left:10px;">(äºˆå®šãªã—)</div>`;
            } else {
                dayList.forEach((item, i) => {
                    const memoHtml = item.memo ? `<div class="summary-memo">ğŸ“ ${item.memo}</div>` : '';
                    // æ»åœ¨æ™‚é–“ã®è¡¨ç¤º
                    let info = "";
                    if (i === 0 && dayList.length > 1) {
                        info = "(å‡ºç™ºåœ°)";
                    } else {
                        info = `(æ»åœ¨: ${item.time}åˆ†)`;
                    }

                    html += `
                        <div class="summary-item">
                            <span class="summary-item-bullet">â—</span>
                            <div style="flex:1;">
                                <span style="font-weight:bold;">${item.name}</span>
                                <span style="color:#666;">${info}</span>
                                ${memoHtml}
                            </div>
                        </div>
                    `;
                });
            }
            dayDiv.innerHTML = html;
            container.appendChild(dayDiv);
        });

        document.getElementById('summaryModal').style.display = 'flex';
    };

    // --- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­è¾¼ ---
    function renderSavedPlansList() {
        const listEl = document.getElementById('saved-plans-list');
        listEl.innerHTML = '';
        const allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        const names = Object.keys(allSaves).reverse();
        if (names.length === 0) { listEl.innerHTML = '<li style="text-align:center; color:#888; padding:20px;">ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“</li>'; return; }
        names.forEach(name => {
            const data = allSaves[name];
            const dateStr = new Date(data.savedAt).toLocaleDateString();
            const li = document.createElement('li');
            li.className = 'saved-plan-card';
            li.innerHTML = `
                <div class="plan-info" onclick="loadTrip('${name}')" style="flex:1">
                    <h3>${name}</h3>
                    <div class="plan-date">æœ€çµ‚ä¿å­˜: ${dateStr}</div>
                </div>
                <div class="plan-delete" onclick="deleteTrip('${name}')" title="å‰Šé™¤">ğŸ—‘</div>
            `;
            listEl.appendChild(li);
        });
    }
    function saveTrip() {
        let name = currentPlanName || prompt("ãƒ—ãƒ©ãƒ³åã‚’å…¥åŠ›:", "æ±äº¬æ—…è¡Œ");
        if (!name) return;
        currentPlanName = name;
        const saveData = { tripData: tripData, savedAt: new Date().toISOString() };
        let allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        allSaves[name] = saveData;
        localStorage.setItem("travel_planner_saves", JSON.stringify(allSaves));
        alert(`ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
    }
    window.loadTrip = (name) => {
        let allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        if (allSaves[name]) {
            tripData = allSaves[name].tripData;
            currentDayIndex = 0; currentPlanName = name;
            showPlanner();
        }
    };
    window.deleteTrip = (name) => {
        if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        let allSaves = JSON.parse(localStorage.getItem("travel_planner_saves") || "{}");
        delete allSaves[name];
        localStorage.setItem("travel_planner_saves", JSON.stringify(allSaves));
        renderSavedPlansList();
    };

    // --- ãƒ­ã‚¸ãƒƒã‚¯ ---
    function renderTabs() {
        const container = document.getElementById('dayTabs');
        container.innerHTML = '';
        tripData.days.forEach((_, idx) => {
            const btn = document.createElement('div');
            btn.className = `day-tab ${idx === currentDayIndex ? 'active' : ''}`;
            btn.innerText = `Day ${idx + 1}`;
            btn.onclick = () => switchDay(idx);
            container.appendChild(btn);
        });
        const addBtn = document.createElement('button');
        addBtn.className = 'add-day-btn';
        addBtn.innerText = 'ï¼‹';
        addBtn.onclick = addDay;
        container.appendChild(addBtn);
    }
    function switchDay(idx) {
        currentDayIndex = idx; renderTabs();
        document.getElementById('startTime').value = tripData.startTimes[idx] || "09:00";
        refreshSchedule();
    }
    function addDay() { tripData.days.push([]); tripData.startTimes.push("09:00"); switchDay(tripData.days.length - 1); }
    function updateStartTime(val) { tripData.startTimes[currentDayIndex] = val; refreshSchedule(); }
    
    function addCurrentLocation() {
        if (!navigator.geolocation) { alert("ä½ç½®æƒ…å ±éå¯¾å¿œ"); return; }
        navigator.geolocation.getCurrentPosition(pos => {
            const latLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            map.setCenter(latLng);
            getCurrentDayList().push({ id: Date.now(), name: "ç¾åœ¨åœ°", time: 0, latLng: latLng, mode: "DRIVING", isMove: false, memo: "" });
            refreshSchedule();
        }, () => alert("å–å¾—å¤±æ•—"));
    }
    async function addNewLocation() {
        const name = document.getElementById('placeName').value;
        const time = parseInt(document.getElementById('stayTime').value);
        const mode = document.getElementById('travelMode').value;
        const latLng = window.currentLatLng;
        if (!latLng) { alert("å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
        const latLngObj = (typeof latLng.toJSON === 'function') ? latLng.toJSON() : latLng;
        getCurrentDayList().push({ id: Date.now(), name, time, latLng: latLngObj, mode, isMove: false, memo: "" });
        await refreshSchedule();
        document.getElementById('placeName').value = '';
        window.currentLatLng = null;
    }
    function getCurrentDayList() { return tripData.days[currentDayIndex]; }
    function clearMapOverlays() {
        routeRenderers.forEach(r => r.setMap(null)); routeRenderers = [];
        markers.forEach(m => m.setMap(null)); markers = [];
    }
    function updateItem(id, key, value) {
        const list = getCurrentDayList();
        const item = list.find(d => d.id === id);
        if (item) {
            if (key === 'time') item.time = parseInt(value);
            if (key === 'mode') item.mode = value;
            refreshSchedule();
        }
    }
    function syncOrderFromDOM() {
        const currentList = getCurrentDayList();
        const newList = [];
        const items = document.querySelectorAll('.schedule-item:not(.item-move)');
        items.forEach(el => {
            const id = parseFloat(el.getAttribute('data-id'));
            const data = currentList.find(d => d.id === id);
            if (data) newList.push(data);
        });
        if (newList.length > 0) tripData.days[currentDayIndex] = newList;
    }
    async function refreshSchedule() {
        clearMapOverlays();
        const list = getCurrentDayList();
        const timeStr = tripData.startTimes[currentDayIndex] || "09:00";
        const [h, m] = timeStr.split(':').map(Number);
        let currentTimeMin = h * 60 + m;
        const finalDisplayData = [];
        const chartSegments = [];
        list.forEach((item, idx) => {
            markers.push(new google.maps.Marker({
                position: item.latLng, map: map, label: (idx + 1).toString(), title: item.name
            }));
        });
        for (let i = 0; i < list.length; i++) {
            const item = list[i];
            if (i > 0) {
                const prev = list[i-1];
                const routeRes = await calculateRoute(prev.latLng, item.latLng, item.mode);
                const moveDuration = routeRes.time;
                chartSegments.push({ label: `ç§»å‹•`, color: '#ff9800', duration: moveDuration });
                finalDisplayData.push({
                    id: item.id, name: `ç§»å‹•`, time: moveDuration, isMove: true, mode: item.mode,
                    startTime: formatTime(currentTimeMin), endTime: formatTime(currentTimeMin + moveDuration)
                });
                currentTimeMin += moveDuration;
            }
            const colors = ['#4285f4', '#34a853', '#ea4335', '#a142f4', '#00acc1'];
            const color = colors[i % colors.length];
            const actualStay = (i === 0 && list.length > 1) ? 0 : item.time;
            if (actualStay > 0) chartSegments.push({ label: item.name, color: color, duration: actualStay });
            finalDisplayData.push({
                ...item, startTime: formatTime(currentTimeMin), endTime: formatTime(currentTimeMin + actualStay)
            });
            currentTimeMin += actualStay;
        }
        renderList(finalDisplayData);
        updateClockCharts(chartSegments, h * 60 + m);
    }
    function calculateRoute(start, end, mode) {
        return new Promise(resolve => {
            directionsService.route({
                origin: start, destination: end, travelMode: google.maps.TravelMode[mode]
            }, (res, status) => {
                let time = 15;
                if (status === 'OK') {
                    time = Math.ceil(res.routes[0].legs[0].duration.value / 60);
                    const renderer = new google.maps.DirectionsRenderer({
                        map: map, directions: res, suppressMarkers: true,
                        polylineOptions: { strokeColor: mode==='WALKING'?'#4caf50':(mode==='TRANSIT'?'#9c27b0':'#1a73e8'), strokeWeight: 5, strokeOpacity: 0.6 }
                    });
                    routeRenderers.push(renderer);
                }
                resolve({ time: time });
            });
        });
    }
    function formatTime(totalMin) {
        let h = Math.floor(totalMin / 60) % 24;
        let m = totalMin % 60;
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }
    window.openMemoModal = (id) => {
        const item = getCurrentDayList().find(d => d.id === id);
        if (!item) return;
        editingMemoId = id;
        document.getElementById('memoInput').value = item.memo || "";
        document.getElementById('memoModal').style.display = 'flex';
        document.getElementById('memoInput').focus();
    };
    window.closeMemoModal = () => { document.getElementById('memoModal').style.display = 'none'; editingMemoId = null; };
    window.saveMemo = () => {
        if (editingMemoId === null) return;
        const item = getCurrentDayList().find(d => d.id === editingMemoId);
        if (item) { item.memo = document.getElementById('memoInput').value; refreshSchedule(); }
        closeMemoModal();
    };
    window.deleteItem = (id) => {
        const list = getCurrentDayList();
        const idx = list.findIndex(d => d.id === id);
        if (idx > -1) { list.splice(idx, 1); refreshSchedule(); }
    };
    function renderList(data) {
        const list = document.getElementById('scheduleList');
        list.innerHTML = '';
        data.forEach(item => {
            const li = document.createElement('li');
            li.className = `schedule-item ${item.isMove ? 'item-move' : ''}`;
            if (!item.isMove) li.setAttribute('data-id', item.id);
            if (item.isMove) {
                li.innerHTML = `
                    <div class="item-row">
                        <span style="font-size:0.8rem">ğŸš— ç§»å‹• (${item.time}åˆ†)</span>
                        <span class="item-time-info">${item.startTime} - ${item.endTime}</span>
                    </div>
                    <div class="edit-row" style="justify-content: flex-end;">
                        <select class="edit-select" onchange="updateItem(${item.id}, 'mode', this.value)">
                            <option value="DRIVING" ${item.mode==='DRIVING'?'selected':''}>è»Š</option>
                            <option value="TRANSIT" ${item.mode==='TRANSIT'?'selected':''}>é›»è»Š</option>
                            <option value="WALKING" ${item.mode==='WALKING'?'selected':''}>å¾’æ­©</option>
                        </select>
                    </div>`;
            } else {
                const isStartPoint = (item.startTime === item.endTime) && (data[0].id === item.id) && data.length > 1;
                const hasMemo = item.memo && item.memo.trim().length > 0;
                const memoClass = hasMemo ? "btn-icon btn-memo has-memo" : "btn-icon btn-memo";
                const tooltipHtml = hasMemo ? `<div class="memo-tooltip">${item.memo}</div>` : "";
                li.innerHTML = `
                    <div class="item-row">
                        <span class="item-name"><span class="drag-handle">â˜°</span> ${item.name}</span>
                        <div class="item-time-info"><div>${item.startTime} - ${item.endTime}</div></div>
                    </div>
                    <div class="edit-row">
                        <div style="display:flex; align-items:center;">
                            ${isStartPoint ? '<span>(å‡ºç™º)</span>' : `æ»åœ¨:<input type="number" class="edit-input" value="${item.time}" onchange="updateItem(${item.id}, 'time', this.value)">åˆ†`}
                        </div>
                        <div style="display:flex; align-items:center;">
                            <div class="memo-wrapper"><button class="${memoClass}" onclick="openMemoModal(${item.id})">ğŸ“</button>${tooltipHtml}</div>
                            <button class="btn-icon btn-del" onclick="deleteItem(${item.id})">ğŸ—‘</button>
                        </div>
                    </div>`;
            }
            list.appendChild(li);
        });
    }
    function updateClockCharts(segments, startMin) {
        const amData = [], amColors = [], pmData = [], pmColors = [];
        let current = 0;
        function addSegment(duration, color) {
            if (duration <= 0) return;
            const segStart = current; const segEnd = current + duration;
            if (segStart < 720) { amData.push(Math.min(segEnd, 720) - segStart); amColors.push(color); }
            if (segEnd > 720) { const pmStart = Math.max(segStart, 720); const pmDur = Math.min(segEnd, 1440) - pmStart; if (pmDur > 0) { pmData.push(pmDur); pmColors.push(color); } }
            current += duration;
        }
        addSegment(startMin, 'transparent');
        segments.forEach(seg => addSegment(seg.duration, seg.color));
        if (1440 - current > 0) addSegment(1440 - current, '#f0f0f0');
        if(chartAM) {
            chartAM.data.datasets[0].data = amData; chartAM.data.datasets[0].backgroundColor = amColors; chartAM.update();
            chartPM.data.datasets[0].data = pmData; chartPM.data.datasets[0].backgroundColor = pmColors; chartPM.update();
        }
    }
    function initCharts() {
        const commonConfig = {
            type: 'pie', data: { datasets: [{ data: [], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, rotation: 0, circumference: 360, layout: { padding: 0 }, events: [], plugins: { legend: { display: false }, tooltip: { enabled: false } } }
        };
        const ctxAM = document.getElementById('chartAM').getContext('2d');
        chartAM = new Chart(ctxAM, JSON.parse(JSON.stringify(commonConfig)));
        const ctxPM = document.getElementById('chartPM').getContext('2d');
        chartPM = new Chart(ctxPM, JSON.parse(JSON.stringify(commonConfig)));
    }
    function initSortable() {
        sortable = new Sortable(document.getElementById('scheduleList'), { animation: 150, handle: '.drag-handle', onEnd: async () => { syncOrderFromDOM(); await refreshSchedule(); } });
    }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDaOSP3v96sTjeE9YDKl1AqURjCA8jr7Ro&callback=initMap&libraries=places" async defer></script>
</body>
</html>